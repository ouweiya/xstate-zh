---
title: '@xstate/test'
---

:::warningxstate

æœ€æ–°ç‰ˆæœ¬çš„åŸºäºæ¨¡å‹çš„æµ‹è¯•å·¥å…·ï¼ˆä»¥å‰çš„ `@xstate/test`ï¼‰ç°åœ¨æ˜¯æœ€æ–°çš„ `@xstate/graph` åŒ…çš„ä¸€éƒ¨åˆ†ã€‚

`@xstate/graph` çš„æ–‡æ¡£ï¼ˆåŒ…æ‹¬æµ‹è¯•å·¥å…·ï¼‰å³å°†å‘å¸ƒï¼›ä»¥ä¸‹æ–‡æ¡£é€‚ç”¨äº `@xstate/test@beta`ã€‚

:::

[@xstate/test åŒ…](https://github.com/statelyai/xstate/tree/main/packages/xstate-test) åŒ…å«äº†ç”¨äºä¿ƒè¿›ä»»ä½•è½¯ä»¶çš„[åŸºäºæ¨¡å‹çš„æµ‹è¯•](https://en.wikipedia.org/wiki/Model-based_testing)çš„å·¥å…·ã€‚

**è§‚çœ‹æ¼”è®²**ï¼š[å†™æ›´å°‘çš„æµ‹è¯•ï¼ä»è‡ªåŠ¨åŒ–åˆ°è‡ªåŠ¨ç”Ÿæˆ](https://slides.com/davidkhourshid/mbt) åœ¨ React Rally 2019 ([ğŸ¥ è§†é¢‘](https://www.youtube.com/watch?v=tpNmPKjPSFQ))

## å¿«é€Ÿå¼€å§‹

1. å®‰è£… `xstate` å’Œ `@xstate/test`ï¼š

```bash
npm install xstate @xstate/test
```

2. åˆ›å»ºå°†ç”¨äºå»ºæ¨¡è¢«æµ‹ç³»ç»Ÿï¼ˆSUTï¼‰çš„çŠ¶æ€æœºï¼š

```js
import { createMachine } from 'xstate';

const toggleMachine = createMachine({
  id: 'toggle',
  initial: 'inactive',
  states: {
    inactive: {
      on: {
        TOGGLE: 'active',
      },
    },
    active: {
      on: {
        TOGGLE: 'inactive',
      },
    },
  },
});
```

3. ä¸ºçŠ¶æ€æœºä¸­çš„æ¯ä¸ªçŠ¶æ€æ·»åŠ æ–­è¨€ï¼ˆåœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œä½¿ç”¨ [Puppeteer](https://github.com/GoogleChrome/puppeteer)ï¼‰ï¼š

```js
// ...

const toggleMachine = createMachine({
  id: 'toggle',
  initial: 'inactive',
  states: {
    inactive: {
      on: {
        /* ... */
      },
      meta: {
        test: async (page) => {
          await page.waitFor('input:checked');
        },
      },
    },
    active: {
      on: {
        /* ... */
      },
      meta: {
        test: async (page) => {
          await page.waitFor('input:not(:checked)');
        },
      },
    },
  },
});
```

4. åˆ›å»ºæ¨¡å‹ï¼š

```js
import { createMachine } from 'xstate';
import { createModel } from '@xstate/test';

const toggleMachine = createMachine(/* ... */);

const toggleModel = createModel(toggleMachine).withEvents({
  TOGGLE: {
    exec: async (page) => {
      await page.click('input');
    },
  },
});
```

5. åˆ›å»ºæµ‹è¯•è®¡åˆ’å¹¶è¿è¡Œè¦†ç›–ç‡æµ‹è¯•ï¼š

```js
// ...

describe('toggle', () => {
  const testPlans = toggleModel.getShortestPathPlans();

  testPlans.forEach((plan) => {
    describe(plan.description, () => {
      plan.paths.forEach((path) => {
        it(path.description, async () => {
            // è¿›è¡Œä»»ä½•è®¾ç½®ï¼Œç„¶å...

          await path.test(page);
        });
      });
    });
  });

  it('should have full coverage', () => {
    return toggleModel.testCoverage();
  });
});
```

## API

### `createModel(machine, options?)`

åŸºäºä¼ å…¥çš„ `machine` åˆ›å»ºä¸€ä¸ªæŠ½è±¡çš„æµ‹è¯•æ¨¡å‹ã€‚

| å‚æ•°       | ç±»å‹             | æè¿°                                    |
| ---------- | ---------------- | --------------------------------------- |
| `machine`  | StateMachine     | ç”¨äºåˆ›å»ºæŠ½è±¡æ¨¡å‹çš„çŠ¶æ€æœºã€‚              |
| `options?` | TestModelOptions | è‡ªå®šä¹‰æŠ½è±¡æ¨¡å‹çš„é€‰é¡¹                    |

#### è¿”å›å€¼

ä¸€ä¸ª `TestModel` å®ä¾‹ã€‚

### æ–¹æ³•

#### `model.withEvents(eventsMap)`

ä¸ºæ¯ä¸ªäº‹ä»¶æä¾›æµ‹è¯•ç»†èŠ‚ã€‚`eventsMap` ä¸­çš„æ¯ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶é”®æ˜¯äº‹ä»¶ç±»å‹ï¼Œå±æ€§æè¿°äº†æ¯ä¸ªäº‹ä»¶çš„æ‰§è¡Œå’Œæµ‹è¯•ç”¨ä¾‹ï¼š

- `exec` (å‡½æ•°): æ‰§è¡Œäº‹ä»¶çš„å‡½æ•°ã€‚å®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼š
  - `testContext` (ä»»æ„ç±»å‹): ä»»ä½•ä¸Šä¸‹æ–‡æµ‹è¯•æ•°æ®
  - `event` (EventObject): ç”±æµ‹è¯•æ¨¡å‹å‘é€çš„äº‹ä»¶
- `cases?` (EventObject[]): è¯¥äº‹ä»¶ç±»å‹å¯ä»¥ç”±æµ‹è¯•æ¨¡å‹å‘é€çš„ç¤ºä¾‹äº‹ä»¶å¯¹è±¡ã€‚

ç¤ºä¾‹ï¼š

```js
const toggleModel = createModel(toggleMachine).withEvents({
  TOGGLE: {
    exec: async (page) => {
      await page.click('input');
    },
  },
});
```

### `testModel.getShortestPathPlans(options?)`

è¿”å›åŸºäºä»æµ‹è¯•æ¨¡å‹çš„åˆå§‹çŠ¶æ€åˆ°æ¯ä¸ªå…¶ä»–å¯è¾¾çŠ¶æ€çš„æœ€çŸ­è·¯å¾„çš„æµ‹è¯•è®¡åˆ’æ•°ç»„ã€‚

#### é€‰é¡¹

| å‚æ•°     | ç±»å‹     | æè¿°                                                                                                    |
| -------- | -------- | ------------------------------------------------------------------------------------------------------- |
| `filter` | function | æ¥å— `state` å¹¶è¿”å› `true` å¦‚æœçŠ¶æ€åº”è¯¥è¢«éå†ï¼Œæˆ–è€…è¿”å› `false` å¦‚æœéå†åº”è¯¥åœæ­¢ã€‚|

è¿™å¯¹äºé˜²æ­¢æ— é™éå†å’Œå †æ ˆæº¢å‡ºé”™è¯¯éå¸¸æœ‰ç”¨ï¼š

```js
const todosModel = createModel(todosMachine).withEvents({
  /* ... */
});

const plans = todosModel.getShortestPathPlans({
  // å‘Šè¯‰ç®—æ³•å°†çŠ¶æ€/äº‹ä»¶é‚»æ¥å›¾é™åˆ¶ä¸ºæ‹¥æœ‰å°‘äº 5 ä¸ªå¾…åŠäº‹é¡¹çš„çŠ¶æ€
  filter: (state) => state.context.todos.length < 5,
});
```

### `testModel.getSimplePathPlans(options?)`

è¿”å›åŸºäºä»æµ‹è¯•æ¨¡å‹çš„åˆå§‹çŠ¶æ€åˆ°æ¯ä¸ªå…¶ä»–å¯è¾¾çŠ¶æ€çš„ç®€å•è·¯å¾„çš„æµ‹è¯•è®¡åˆ’æ•°ç»„ã€‚

#### é€‰é¡¹

| å‚æ•°     | ç±»å‹     | æè¿°                                                                                                    |
| -------- | -------- | ------------------------------------------------------------------------------------------------------- |
| `filter` | function | æ¥å— `state` å¹¶è¿”å› `true` å¦‚æœçŠ¶æ€åº”è¯¥è¢«éå†ï¼Œæˆ–è€…è¿”å› `false` å¦‚æœéå†åº”è¯¥åœæ­¢ã€‚|

### `testModel.getPlanFromEvents(events, options)`

| å‚æ•°     | ç±»å‹                 | æè¿°                                                                                                    |
| -------- | -------------------- | ------------------------------------------------------------------------------------------------------- |
| `events` | `EventObject[]`      | ç”¨äºåˆ›å»ºè®¡åˆ’çš„äº‹ä»¶åºåˆ—                                                                                  |
| `options`| `{ target: string }` | ä¸€ä¸ªåŒ…å« `target` å±æ€§çš„å¯¹è±¡ï¼Œè¯¥å±æ€§åº”åŒ¹é…äº‹ä»¶çš„ç›®æ ‡çŠ¶æ€                                                |

è¿”å›ä¸€ä¸ªåŒ…å«å•ä¸ªè·¯å¾„çš„å•ä¸ªæµ‹è¯•è®¡åˆ’çš„æ•°ç»„ï¼Œè¯¥è·¯å¾„ç”± `events` ç”Ÿæˆã€‚

å¦‚æœæœ€åè¿›å…¥çš„çŠ¶æ€ä¸ `options.target` ä¸åŒ¹é…ï¼Œåˆ™æŠ›å‡ºé”™è¯¯ã€‚

### `testModel.testCoverage(options?)`

æµ‹è¯•åœ¨æ‰§è¡Œçš„æµ‹è¯•ä¸­æ˜¯å¦è¦†ç›–ï¼ˆéå†ï¼‰äº†æ‰€æœ‰çŠ¶æ€èŠ‚ç‚¹ã€‚

#### é€‰é¡¹

| å‚æ•°     | ç±»å‹     | æè¿°                                                                                                    |
| -------- | -------- | ------------------------------------------------------------------------------------------------------- |
| `filter` | function | æ¥å—æ¯ä¸ª `stateNode` å¹¶è¿”å› `true` å¦‚æœè¯¥çŠ¶æ€èŠ‚ç‚¹åº”è¯¥è¢«è¦†ç›–ã€‚                                           |

```js
// ä»…æµ‹è¯•å®šä¹‰äº† `.meta` å±æ€§çš„çŠ¶æ€èŠ‚ç‚¹çš„è¦†ç›–ç‡ï¼š

testModel.testCoverage({
  filter: (stateNode) => !!stateNode.meta,
});
```

### `testPlan.description`

æµ‹è¯•è®¡åˆ’çš„å­—ç¬¦ä¸²æè¿°ï¼Œæè¿°äº†è¾¾åˆ° `testPlan.state` çš„ç›®æ ‡ã€‚

### `testPlan.paths`

ä»æµ‹è¯•æ¨¡å‹çš„åˆå§‹çŠ¶æ€åˆ°æ¯ä¸ªå…¶ä»–å¯è¾¾çŠ¶æ€çš„æµ‹è¯•è·¯å¾„ã€‚

### `testPath.description`

æµ‹è¯•è·¯å¾„çš„å­—ç¬¦ä¸²æè¿°ï¼Œæè¿°äº†ä¸€ç³»åˆ—å°†è¾¾åˆ° `testPath.state` çš„äº‹ä»¶ã€‚

### `testPath.test(testContext)`

é€šè¿‡ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œ `testPath.segments` ä¸­çš„æ¯ä¸€æ­¥ï¼š

1. éªŒè¯ SUT å¤„äº `segment.state`
2. æ‰§è¡Œ `segment.event` çš„äº‹ä»¶

æœ€åï¼ŒéªŒè¯ SUT å¤„äºç›®æ ‡ `testPath.state`ã€‚

æ³¨æ„ï¼šå¦‚æœæ‚¨çš„æ¨¡å‹æœ‰åµŒå¥—çŠ¶æ€ï¼Œåœ¨éªŒè¯ SUT å¤„äºè¯¥åµŒå¥—çŠ¶æ€æ—¶ï¼Œæ¯ä¸ªçˆ¶çŠ¶æ€çš„ `meta.test` æ–¹æ³•ä¹Ÿä¼šè¢«æ‰§è¡Œã€‚
