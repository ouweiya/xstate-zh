---
title: ä½¿ç”¨ XState å’Œ React ç®¡ç†å…¨å±€çŠ¶æ€
description: å¦‚ä½•ä½¿ç”¨ XState åœ¨ React ä¸­ç®¡ç†å…¨å±€çŠ¶æ€
tags:
  [
    xstate,
    react
  ]
authors: [david]
date: 2024-02-12
slug: 2024-02-12-xstate-react-global-state
image: /blog/2024-02-12-xstate-react-global-state.png
---

XState æ˜¯ä¸€ä¸ªå¤šåŠŸèƒ½çš„çŠ¶æ€ç®¡ç†å’Œç¼–æ’åº“ï¼Œå¯ä»¥ä¸ä»»ä½•æ¡†æ¶ä¸€èµ·ä½¿ç”¨ï¼ŒåŒ…æ‹¬ä¸ [`@xstate/react`](/docs/xstate-react) åŒ…ä¸€èµ·ä½¿ç”¨çš„ Reactã€‚å¯¹äºè®¸å¤šåº”ç”¨ç¨‹åºæ¥è¯´ï¼Œç®¡ç†å…¨å±€çŠ¶æ€æ˜¯ä¸€ä¸ªè¦æ±‚ï¼Œæœ‰å¾ˆå¤šé€‰é¡¹å¯ä»¥åœ¨ React ä¸­å…±äº«å…¨å±€çŠ¶æ€ï¼Œæ¯”å¦‚ä½¿ç”¨ [React Context](https://react.dev/learn/passing-data-deeply-with-context) æˆ–è€…åƒ [Redux](https://redux.js.org/)ã€[MobX](https://mobx.js.org/) å’Œ [Zustand](https://github.com/pmndrs/zustand) è¿™æ ·çš„åº“ã€‚

`@xstate/react` åŒ…ä½¿å¾—ä½¿ç”¨ `useMachine()` å’Œ `useActor()` è¿™æ ·çš„é’©å­æ¥ç®¡ç†ç»„ä»¶çº§çŠ¶æ€å˜å¾—ç®€å•ï¼Œä½†å®ƒåŒæ ·é€‚ç”¨äºç®¡ç†å…¨å±€çŠ¶æ€ ğŸŒ

{/* truncate */}

## å¿«é€Ÿå¼€å§‹

1. **åˆ›å»ºå…¨å±€é€»è¾‘**ã€‚è¿™å¯ä»¥æ˜¯ä¸€ä¸ªç®€å•çš„ promise æˆ–å‡½æ•°ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªå¤æ‚çš„çŠ¶æ€æœºæˆ–çŠ¶æ€å›¾ã€‚
1. **ä»è¯¥é€»è¾‘åˆ›å»ºä¸€ä¸ª actor å¹¶å¯¼å‡ºå®ƒ**ã€‚
1. **ä»ä»»ä½•ç»„ä»¶ä¸­å¯¼å…¥è¯¥ actor** å¹¶ï¼š
    - ä½¿ç”¨ `useSelector(â€¦)` é’©å­è¯»å– actor çš„å¿«ç…§
    - è°ƒç”¨ `actorRef.send(â€¦)` å‘é€äº‹ä»¶ç»™å®ƒã€‚

å°±æ˜¯è¿™æ ·ï¼

```tsx
import { setup, createActor } from 'xstate';
import { useSelector } from '@xstate/react';

// å…¨å±€åº”ç”¨é€»è¾‘
import { globalLogic } from './globalLogic';

// highlight-start
// åˆ›å»º actor
export const globalActor = createActor(globalLogic);
// å¯åŠ¨ actor
globalActor.start();
// highlight-end

export function App() {
  // highlight-start
  // è¯»å– actor çš„å¿«ç…§
  const user = useSelector(globalActor, (snapshot) => snapshot.context.user);
  // highlight-end

  return (
    <div>
      <h1>ä½ å¥½, {user.name}!</h1>
      // highlight-start
      // å‘é€äº‹ä»¶ç»™ actor
      <button onClick={() => globalActor.send({ type: 'logout' })}>
      // highlight-end
      ç™»å‡º
      </button>
    </div>
  );
}
```

## å…¨å±€çŠ¶æ€

ç®¡ç†å…¨å±€çŠ¶æ€çš„æœ€ç®€å•æ–¹æ³•æ˜¯å…±äº«ä¸€ä¸ª[actor](/docs/actors)å®ä¾‹ã€‚å¯ä»¥å°† actor è§†ä¸ºä¸€ä¸ªâ€œå­˜å‚¨â€â€”â€”ä½ å¯ä»¥è®¢é˜…å®ƒçš„çŠ¶æ€æ›´æ–°ï¼ˆâ€œå¿«ç…§â€ï¼‰å¹¶å‘å®ƒå‘é€äº‹ä»¶ã€‚

ä½ å¯ä»¥é€šè¿‡å°† actor ä½œä¸º prop ä¼ é€’æˆ–ç›´æ¥ä»æ¨¡å—èŒƒå›´å¼•ç”¨æ¥åœ¨ä»»ä½•ç»„ä»¶ä¸­ä½¿ç”¨å®ƒã€‚

```tsx
import { setup, createActor } from 'xstate';
import { useSelector } from '@xstate/react';

// å…¨å±€åº”ç”¨é€»è¾‘
const countMachine = createMachine({
  context: { count: 0 },
  on: {
    inc: {
      actions: assign({ count: ({ context }) => context.count + 1 })
    }
  }
});

// highlight-start
// å…¨å±€ actor - åº”ç”¨é€»è¾‘çš„ä¸€ä¸ªå®ä¾‹
export const countActor = createActor(countMachine);
countActor.start(); // ç«‹å³å¯åŠ¨ actor
// highlight-end

export function App() {
  // highlight-start
  // è¯»å– actor çš„å¿«ç…§
  const count = useSelector(countActor, (state) => state.context.count);
  // highlight-end

  return (
    // highlight-start
    // å‘é€äº‹ä»¶ç»™ actor
    <button onClick={() => countActor.send({ type: 'inc' })}>
    // highlight-end
      Count: {count}
    </button>
  );
}
```

ä½ å¯ä»¥ä»ä»»ä½•ç»„ä»¶ä¸­è¯»å–è¿™ä¸ªå…¨å±€ actorï¼ˆâ€œå­˜å‚¨â€ï¼‰å¹¶å‘å®ƒå‘é€äº‹ä»¶ï¼š

```tsx
// highlight-next-line
import { countActor } from './countActor';

export function Counter() {
  // highlight-next-line
  const count = useSelector(countActor, (state) => state.context.count);

  return (
    // highlight-next-line
    <button onClick={() => countActor.send({ type: 'inc' })}>
      Current count: {count}
    </button>
  );
}
```

## å‰¯ä½œç”¨å’Œç”Ÿå‘½å‘¨æœŸ

actor ä¸ä»…é™äºä½œä¸ºçŠ¶æ€å­˜å‚¨ã€‚å®ƒä»¬è¿˜å¯ä»¥ç”¨äºç®¡ç†å‰¯ä½œç”¨ï¼Œæ¯”å¦‚ HTTP è¯·æ±‚ï¼Œæˆ–è€…ä» actor å†…éƒ¨è§¦å‘å‰¯ä½œç”¨ã€‚å› æ­¤ï¼Œä½ å¯èƒ½ä¸å¸Œæœ› actor ç«‹å³å¯åŠ¨ã€‚ä½ å¯ä»¥ä½¿ç”¨ `.start()` æ–¹æ³•åœ¨é€‚å½“çš„æ—¶é—´å¯åŠ¨ actorï¼Œæ¯”å¦‚åœ¨åº”ç”¨æŒ‚è½½æ—¶ã€‚

:::tip

å¦‚æœ actor å·²ç»å¯åŠ¨ï¼Œå†æ¬¡è°ƒç”¨ `.start()` å°†ä¸ä¼šæœ‰ä»»ä½•æ•ˆæœã€‚è¿™ä½¿å¾—åœ¨ `useEffect()` ä¸­è°ƒç”¨å®ƒæ˜¯å®‰å…¨çš„ï¼Œ`useEffect()` [åœ¨å¼€å‘ç¯å¢ƒçš„ä¸¥æ ¼æ¨¡å¼ä¸‹ä¼šæ‰§è¡Œä¸¤æ¬¡](https://react.dev/reference/react/useEffect#my-effect-runs-twice-when-the-component-mounts)ã€‚

:::

```ts
import { effectfulActor } from './effectfulActor';

export function App() {
  useEffect(() => {
    // highlight-next-line
    effectfulActor.start();
  }, [effectfulActor]);

  // ...
}
```

åŒæ ·ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨ `actor.stop()` æ¥æ§åˆ¶ actor ä½•æ—¶åœæ­¢ã€‚

:::info

å…¨å±€ä½¿ç”¨çš„ actor å¿…é¡»æ˜¾å¼å¯åŠ¨ (`actor.start()`)ã€‚å½“ä½¿ç”¨ `@xstate/react` é’©å­å¦‚ `useMachine(â€¦)`ã€`useSelector(â€¦)` ç­‰æ—¶ï¼Œactor ä¼šè‡ªåŠ¨å¯åŠ¨å’Œåœæ­¢ã€‚

:::

## ä½¿ç”¨ React Context ç®¡ç†å…¨å±€çŠ¶æ€

å¦‚æœä½ æ›´å–œæ¬¢ä½¿ç”¨ [React Context](https://react.dev/learn/passing-data-deeply-with-context) æ¥å…±äº«å…¨å±€çŠ¶æ€ï¼Œä½ å¯ä»¥å°†ä¸Šè¿°æ¨¡å¼é€‚é…ä¸ºä½¿ç”¨ React Context æä¾›è€…å’Œæ¶ˆè´¹è€…ã€‚

```tsx
import { createContext } from 'react';

const someMachine = createMachine(/* ... */);
const someActor = createActor(someMachine);

// ä¸è¦å¿˜è®°å¯åŠ¨ actorï¼
someActor.start();

// å°† `someActor` ä¼ é€’ç»™ `createContext` ä¸»è¦æ˜¯ä¸ºäº†ç±»å‹å®‰å…¨
// highlight-next-line
export const SomeActorContext = createContext(someActor);

export function App() {
  return (
    // highlight-next-line
    <SomeActorContext.Provider value={someActor}>
      <Counter />
    // highlight-next-line
    </SomeActorContext.Provider>
  );
}
```

```tsx
import { useContext } from 'react';
import { useSelector } from '@xstate/react';
// highlight-next-line
import { SomeActorContext } from './SomeActorContext';

export function Counter() {
  // highlight-next-line
  const someActor = useContext(SomeActorContext);
  const count = useSelector(someActor, (state) => state.context.count);

  return (
    // highlight-next-line
    <button onClick={() => someActor.send({ type: 'inc' })}>
      Current count: {count}
    </button>
  );
}
```

:::tip

`@xstate/react` åŒ…è¿˜æä¾›äº†ä¸€ä¸ª `createActorContext(â€¦)` å‡½æ•°ä»¥æ–¹ä¾¿ä½¿ç”¨ã€‚é˜…è¯»å…³äº[åœ¨ React ä¸­ä½¿çŠ¶æ€æœºå…¨å±€åŒ–](/blog/2023-1-27-making-state-machines-global-in-react)çš„åšå®¢æ–‡ç« ï¼Œå¹¶æŸ¥çœ‹[`createActorContext(â€¦)` çš„æ–‡æ¡£](/docs/xstate-react#createactorcontextlogic)ã€‚

:::

## ä¸ä»…ä»…æ˜¯çŠ¶æ€æœº

çŠ¶æ€æœºéå¸¸å¼ºå¤§ä¸”æœ‰ç”¨ï¼Œä½†æœ‰æ—¶ä½ ä¸éœ€è¦æ‰€æœ‰è¿™äº›åŠŸèƒ½ã€‚XState v5 ä½¿ä½ èƒ½å¤Ÿåˆ›å»º[ä¸åŒç±»å‹çš„ actor é€»è¾‘](/docs/category/actors)ä»¥é€‚åº”ä½ çš„ç”¨ä¾‹ï¼Œä¾‹å¦‚åŸºäº promiseã€observableã€è½¬æ¢å‡½æ•°ã€å›è°ƒç­‰çš„ actor é€»è¾‘ã€‚

```ts
// highlight-next-line
import { fromTransition, createActor } from 'xstate';
import { useSelector } from '@xstate/react'

// highlight-start
// æ¼”å‘˜é€»è¾‘
const counterLogic = fromTransition((state, event) => {
  if (event.type === 'inc') {
    return { count: state.count + 1 };
  }
  return state;
}, { count: 0 });
// highlight-end

const counterActor = createActor(counterLogic);
counterActor.start();

// Same API
export function Counter() {
  const count = useSelector(counterActor, (state) => state.context.count);

  return (
    <button onClick={() => counterActor.send({ type: 'inc' })}>
      Current count: {count}
    </button>
  );
}
```
