---
title: Viam x Stately - æ™ºèƒ½æœºå™¨ä¸çŠ¶æ€æœºçš„ç»“åˆ
description: æ§åˆ¶ç°å®ä¸–ç•Œä¸­çš„ç¡¬ä»¶éœ€è¦ä¿¡å¿ƒå’Œå®‰å…¨æ€§ï¼Œå³ä½¿å®ƒæ˜¯æ¸¸æˆçš„ä¸€éƒ¨åˆ†ï¼
tags: [æ¡ˆä¾‹ç ”ç©¶, ç ”ç©¶, viam, xstate, çŠ¶æ€æœº]
authors: [hipsterbrown]
date: 2024-07-29
slug: 2024-07-29-claw-game-state-machine
---

â€œæœºå™¨äººâ€ä¸€è¯å¼•å‘äº†å„ç§å„æ ·çš„æƒ³æ³•ï¼Œä»æ‰‹åŠ¨æ§åˆ¶çš„æœºå™¨åˆ°è‡ªåŠ¨åŒ–çš„è½¯ä»¶çˆ¬è™«ã€‚åœ¨è¿™ä¸ªé¢†åŸŸçš„ä¸€ä¸ªä¸»è¦ä¾‹å­æ˜¯æœºå™¨äººæ‰‹è‡‚ï¼Œä¼ ç»Ÿä¸Šç”¨äºå¸®åŠ©å’Œæ‰©å±•äººç±»åœ¨åˆ¶é€ ã€æ‰‹æœ¯å’Œå¤ªç©ºæ¢ç´¢ä¸­çš„èƒ½åŠ›ã€‚è¿™äº›ç”¨ä¾‹ä¸­çš„æ¯ä¸€ä¸ªéƒ½éœ€è¦æŸç§æ–¹å¼æ¥ç¼–ç¨‹å’Œæ§åˆ¶æ‰‹è‡‚ä»¥æ‰§è¡Œå…¶ä¸“ç”¨ä»»åŠ¡ï¼Œé€šå¸¸ä½¿ç”¨ç”±åˆ¶é€ å•†å¼€å‘çš„ä¸“æœ‰è½¯ä»¶ã€‚ç”¨æˆ·ç•Œé¢é€šè¿‡è§¦æ‘¸å±è®¾å¤‡æˆ–ç‰©ç†è¿æ¥åˆ°æ‰‹è‡‚çš„æ¡Œé¢åº”ç”¨ç¨‹åºä¸ç¡¬ä»¶ç´§å¯†è€¦åˆï¼Œè¿™ä½¿å¾—å®ƒéš¾ä»¥å®‰å…¨åœ°åœ¨çº¿ä½¿ç”¨ç°ä»£æŠ€æœ¯ã€‚

[Viam](https://www.viam.com/) æä¾›äº†ä¸€ä¸ªå¼€æºè½¯ä»¶æ ˆå’Œä¸€å¥—äº‘æœåŠ¡ï¼Œä½¿å¾—æ²¡æœ‰ä»»ä½•ç¡¬ä»¶ç»éªŒçš„å¼€å‘äººå‘˜ä¹Ÿèƒ½ç®¡ç†å„ç§ç±»å‹çš„æœºå™¨äººï¼ˆå’Œå…¶ä»–æ™ºèƒ½æœºå™¨ï¼‰ã€‚ä¸ºäº†å¸®åŠ©å±•ç¤ºå¯ä»¥ä½¿ç”¨ Viam æ„å»ºçš„ä½“éªŒç±»å‹ï¼Œå¼€å‘è€…å®£ä¼ å›¢é˜Ÿ[æ„å»ºäº†ä¸€ä¸ªè¡—æœºæŠ“å¨ƒå¨ƒæ¸¸æˆ](https://docs.viam.com/tutorials/projects/claw-game/)ï¼Œè¯¥æ¸¸æˆä½¿ç”¨äº†ä¸€ä¸ªå·¥ä¸šæœºå™¨äººæ‰‹è‡‚å’Œä¸€ä¸ªè¡—æœºæŠ“æ‰‹ï¼Œå¯ä»¥é€šè¿‡[TypeScript SDK](https://ts.viam.dev/)é©±åŠ¨çš„å•é¡µ Web åº”ç”¨ç¨‹åºè¿›è¡Œæ“ä½œã€‚

{/* truncate */}

![ä¸€ä¸ªå¤§å‹è¡—æœºæŸœï¼Œé‡Œé¢è£…æ»¡äº†é»‘è‰²ã€çº¢è‰²å’Œç»¿è‰²çš„çƒï¼Œå‘¨å›´æ˜¯ä¸€ä¸ªå¸¦æœ‰è¡—æœºæŠ“æ‰‹çš„æœºå™¨äººæ‰‹è‡‚](./viam-claw-game.jpg)

å³ä½¿æ˜¯ä¸€ä¸ªç›¸å¯¹å—é™çš„ä½“éªŒï¼Œç®¡ç†æ“ä½œæ‰‹è‡‚çš„å„ç§å¯èƒ½åŠ¨ä½œå’ŒçŠ¶æ€ä¹Ÿä½¿å¾—ç»´æŠ¤ Web åº”ç”¨ç¨‹åºçš„ä»£ç å˜å¾—ç›¸å½“å›°éš¾ï¼Œå°¤å…¶æ˜¯å¯¹äºé‚£äº›æƒ³è¦æ›´æ–°æŸäº›åŠŸèƒ½çš„äººæ¥è¯´ã€‚å¤„ç†ä¸æ‰‹è‡‚ç§»åŠ¨æ—¶å¯èƒ½ç¢°æ’çš„éšœç¢ç‰©ç›¸å…³çš„ä»»ä½•é”™è¯¯ï¼Œä»¥åŠé˜²æ­¢åœ¨æ‰‹è‡‚æ­£åœ¨ç§»åŠ¨æˆ–æŠ“å–æ—¶å‘é€å‘½ä»¤ï¼Œè¿™ä¸€ç‚¹éå¸¸é‡è¦ã€‚æ­¤å¤–ï¼Œä½œä¸ºä¸€ä¸ªå¼€æºç¤ºä¾‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä»£ç èƒ½å¤Ÿè¢«å­¦ä¹  Viam çš„å¼€å‘äººå‘˜ç†è§£ï¼Œè€Œä¸ä¼šè¿·å¤±åœ¨ç‰¹å®šäºç”¨æˆ·ç•Œé¢çš„é€»è¾‘ä¸­ã€‚

é‰´äºè¿™ä¸€ä»»åŠ¡å’Œæˆ‘è¿‡å»ä½¿ç”¨ XState çš„ç»éªŒï¼Œæˆ‘é€‰æ‹©äº† Stately Studio å’Œ XState å°†æŠ“å¨ƒå¨ƒæ¸¸æˆ Web åº”ç”¨ç¨‹åºå˜æˆä¸€ä¸ªæ›´æ¥è¿‘ç”Ÿäº§ç¯å¢ƒçš„ç³»ç»Ÿï¼

## ç†è§£é—®é¢˜

![ä¸€ä¸ªç½‘é¡µï¼Œå¸¦æœ‰ä¸€ä¸ª 3x3 çš„æ–¹æ ¼ç½‘æ ¼ï¼Œé‡Œé¢å¡«å……äº†æŒ‡å‘è¡—æœºæŠ“æ‰‹çš„æ–¹å‘ç®­å¤´ï¼Œç½‘æ ¼ä¸‹æ–¹æ˜¯ä¸€ä¸ªå¸¦æœ‰â€œç¥ä½ å¥½è¿ï¼Œç©å¾—å¼€å¿ƒï¼â€çš„ç¬‘è„¸æœºå™¨äºº](./web-app-ui.png)

å¦‚å‰æ‰€è¿°ï¼ŒWeb åº”ç”¨ç¨‹åºå®é™…ä¸Šæ˜¯ä¸€ä¸ªå•é¡µä½“éªŒã€‚å®ƒæ˜¯ä¸€ç»„é™æ€èµ„äº§ï¼ˆ`index.html`ã€`styles.css`ã€`main.ts`ï¼‰ï¼Œç”±è¿è¡Œåœ¨åµŒå…¥å¼ Linux è®¾å¤‡ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º [NVIDIA Jetson Orin Nano](https://docs.viam.com/get-started/prepare/jetson-nano-setup/)ï¼‰ä¸Šçš„é™æ€æ–‡ä»¶æœåŠ¡å™¨ç¼–è¯‘å’Œæä¾›ï¼Œå…¶ä¸­ä¹Ÿè¿è¡Œç€ [viam-server æœºå™¨äººå¼€å‘å·¥å…·åŒ…](https://docs.viam.com/get-started/installation/)ã€‚è¿™çº¯ç²¹æ˜¯ä¸ºäº†æ–¹ä¾¿è€Œä¸æ˜¯å¿…è¦ï¼Œå› ä¸º Viam TypeScript SDK ä½¿ç”¨ WebRTC è¿æ¥åˆ° `viam-server`ï¼Œå› æ­¤è¯¥åº”ç”¨ç¨‹åºå¯ä»¥åœ¨ä¸–ç•Œä¸Šä»»ä½•æœ‰äº’è”ç½‘è¿æ¥çš„è®¾å¤‡ä¸Šè¿è¡Œã€‚

ç”±äºç”¨æˆ·ç•Œé¢æœ¬èº«ç›¸å½“ç®€å•ï¼Œæ²¡æœ‰ä½¿ç”¨å®¢æˆ·ç«¯æ¡†æ¶ï¼›åªæœ‰ DOM API å’Œ Viam SDKã€‚è®©æˆ‘ä»¬çœ‹çœ‹é¡¹ç›®ä¸­ `main.ts` æ–‡ä»¶ä¸­çš„ `main` å‡½æ•°ï¼Œå®ƒæ±‡é›†äº†å¤§éƒ¨åˆ†ä¸ç”¨æˆ·ç•Œé¢å’Œæœºå™¨äººäº¤äº’çš„é€»è¾‘ï¼›æˆ‘ä»¬å¯ä»¥å¼€å§‹è¯†åˆ«æœ‰é™çŠ¶æ€å’ŒåŠ¨ä½œçš„æœºä¼šï¼š

```typescript
async function main() {
  // è¿æ¥åˆ°å®¢æˆ·ç«¯
  let client: Client;
  try {
    client = await connect();
    console.log('å·²è¿æ¥!');
  } catch (error) {
    console.log(error);
    return;
  }
  const motionClient = new MotionClient(client, motionClientName);
  const boardClient = new BoardClient(client, boardClientName);
  const armClient = new ArmClient(client, armClientName);
  const gripperClient = new GripperClient(client, gripperClientName);
  // æ›´å¤šä»£ç å¦‚ä¸‹
```

ä¸€å¼€å§‹ï¼Œæœ‰ä¸€äº›è®¾ç½®é€»è¾‘ç”¨äºè¿æ¥åˆ°æœºå™¨äººï¼Œå¦‚æœæœºå™¨ç¦»çº¿ï¼Œè¿™äº›é€»è¾‘å¯èƒ½ä¼šå¤±è´¥ï¼Œä½†æ²¡æœ‰å¤ªå¤šçš„é”™è¯¯å¤„ç†ã€‚ä»è¿™ä¸ªç‰‡æ®µä¸­ï¼Œæˆ‘è‡³å°‘å¯ä»¥è¯†åˆ«å‡ºå››ç§çŠ¶æ€ï¼š`initializing`ã€`connectingToMachine`ã€`clientErrored` å’Œ `connected`ã€‚ä¸€æ—¦ä¸»å®¢æˆ·ç«¯è¿æ¥åˆ°æœºå™¨äººï¼Œæˆ‘ä»¬å°±ä¼šåˆ›å»ºæˆ‘ä»¬æƒ³è¦æ§åˆ¶çš„æ¯ä¸ªç»„ä»¶å®¢æˆ·ç«¯çš„å®ä¾‹ã€‚

```typescript
let isMoving = false;

function styleMove(state) {
  let element = document.getElementById('grid-container');
  if (state === 'move') {
    element.classList.remove('grid-container-error', 'grid-container-ready');
    element.classList.add('grid-container-moving');
  } else if (state === 'ready') {
    element.classList.remove('grid-container-error', 'grid-container-moving');
    element.classList.add('grid-container-ready');
  } else if (state === 'error') {
    element.classList.remove('grid-container-moving', 'grid-container-ready');
    element.classList.add('grid-container-error');
  }
}
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæœ‰è¶£çš„å¸ƒå°”å˜é‡ï¼ˆ`isMoving`ï¼‰å’Œæ˜¾å¼çŠ¶æ€çš„æ··åˆï¼Œå®ƒä»¬è¢«ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°ï¼Œä»¥æ ·å¼åŒ–æœºå™¨äººæ‰‹è‡‚å¯ä»¥ç§»åŠ¨åˆ°çš„è±¡é™ç½‘æ ¼ã€‚è¿™æœ‰åŠ©äºæä¾›ä¸€äº›é¢å¤–çš„çŠ¶æ€æ¥å»ºæ¨¡ï¼š`ready`ï¼ˆè¿™å¯ä»¥ä¸`connected`çŠ¶æ€åˆ†å¼€ï¼‰å’Œ`moving`ã€‚æ ¹æ®æœºå™¨çš„å½“å‰çŠ¶æ€æ›´æ–°æ ·å¼å¯ä»¥ä½œä¸ºæœºå™¨é…ç½®ä¸­çš„å‰¯ä½œç”¨å‘ç”Ÿï¼Œä¹Ÿå¯ä»¥é€šè¿‡è®¢é˜…æœºå™¨çŠ¶æ€æ¥å®ç°ï¼›æˆ‘ä»¬å¯ä»¥åœ¨ Stately Studio ä¸­å»ºæ¨¡æ—¶æ¢ç´¢è¿™ä¸€ç‚¹ã€‚

```typescript
// å®šä¹‰æŒ‰é’®è¡Œä¸ºçš„è¾…åŠ©å‡½æ•°
async function mouseDown(func: () => Promise<boolean>) {
  if (isMoving) return;
  styleMove('move');
  isMoving = true;
  let success = await func();
  if (success) {
    styleMove('ready');
    isMoving = false;
  }
}

function setButtonBehavior(
  button: HTMLTableCellElement,
  func: () => Promise<boolean>,
) {
  button.addEventListener('mousedown', () => {
    mouseDown(func);
  });
}

async function planarMoveHandler(
  button: HTMLTableCellElement,
  x: number,
  y: number,
) {
  try {
    await inPlaneMove(motionClient, armClient, x, y);
  } catch (error) {
    console.log(error);
    styleMove('error');
    setTimeout(() => {
      styleMove('ready');
      isMoving = false;
    }, moveTimeout);
    return false;
  }
  return true;
}

setButtonBehavior(forwardbutton, () =>
  planarMoveHandler(forwardbutton, -moveDistance, 0),
);
setButtonBehavior(backbutton, () =>
  planarMoveHandler(backbutton, moveDistance, 0),
);
setButtonBehavior(rightbutton, () =>
  planarMoveHandler(rightbutton, 0, moveDistance),
);
setButtonBehavior(leftbutton, () =>
  planarMoveHandler(leftbutton, 0, -moveDistance),
);
```

ç°åœ¨æˆ‘ä»¬è¿›å…¥äº†çœŸæ­£çš„æ“ä½œã€‚`mouseDown`è¾…åŠ©å‡½æ•°åœ¨å‘é€å‘½ä»¤ç»™æœºæ¢°è‡‚æ—¶ï¼Œåšäº†å‡ ä»¶äº‹æ¥åè°ƒç”¨æˆ·ç•Œé¢ï¼šåœ¨æœºæ¢°è‡‚ç§»åŠ¨æ—¶è¿›è¡Œä¿æŠ¤ï¼Œåœ¨è°ƒç”¨åŒ…è£…çš„å¼‚æ­¥å‘½ä»¤ä¹‹å‰æ›´æ–°æ ·å¼å’Œå…¨å±€å˜é‡ï¼Œæ£€æŸ¥å‘½ä»¤çš„ç»“æœï¼Œå¦‚æœæˆåŠŸåˆ™å†æ¬¡æ›´æ–°æ ·å¼å’Œå…¨å±€å˜é‡ã€‚åœ¨`mouseDown`å¤„ç†ç¨‹åºä¸­æ²¡æœ‰é”™è¯¯å¤„ç†ï¼Œ

```typescript
// Define buttons for movement between quadrants
async function moveHandler(func: Promise<void>) {
  try {
    await func;
  } catch (error) {
    console.log(error);
    styleMove('error');
    setTimeout(() => {
      styleMove('ready');
      isMoving = false;
    }, moveTimeout);
    return false;
  }
  return true;
}

setButtonBehavior(gridBackLeft, () =>
  moveHandler(moveToQuadrant(motionClient, armClient, -1, -1)),
);
setButtonBehavior(gridBack, () =>
  moveHandler(moveToQuadrant(motionClient, armClient, -1, 0)),
);
setButtonBehavior(gridBackRight, () =>
  moveHandler(moveToQuadrant(motionClient, armClient, -1, 1)),
);
setButtonBehavior(gridLeft, () =>
  moveHandler(moveToQuadrant(motionClient, armClient, 0, -1)),
);
setButtonBehavior(gridHome, () => moveHandler(home(motionClient, armClient)));
setButtonBehavior(gridRight, () =>
  moveHandler(moveToQuadrant(motionClient, armClient, 0, 1)),
);
setButtonBehavior(gridFrontLeft, () =>
  moveHandler(moveToQuadrant(motionClient, armClient, 1, -1)),
);
setButtonBehavior(gridFrontRight, () =>
  moveHandler(moveToQuadrant(motionClient, armClient, 1, 1)),
);
```

è¿™ä¸æˆ‘ä»¬åˆšåˆšæ¢ç´¢çš„ `inPlanarMove` è®¾ç½®ç±»ä¼¼ï¼Œå› æ­¤å·²ç»æœ‰ä¸€äº›å°†è¿™äº›å·¥ä½œç»“åˆåˆ°ä¸€ä¸ª `moveHandler` ä¸­çš„æ½œåŠ›ï¼Œä½†è¦æ³¨æ„æ··åˆå‰¯ä½œç”¨å’ŒçŠ¶æ€å˜åŒ–çš„è­¦å‘Šã€‚å½“å‰çš„ `moveHandler` å¾ˆå¯èƒ½ä¸åŒ…æ‹¬ `moving` æ ·å¼æ›´æ–°å’Œå…¨å±€å˜é‡æ›´æ”¹ï¼Œå› ä¸º `moveToQuadrant` ä½¿ç”¨äº† [`armClient.isMoving()`](https://docs.viam.com/components/arm/#ismoving) æ–¹æ³•è¿›è¡Œä¿æŠ¤ï¼Œä½†åœ¨ä¸æ¢ç´¢è¯¥å‡½æ•°çš„å®ç°æƒ…å†µä¸‹ï¼Œå¾ˆéš¾çŸ¥é“è¿™ä¸€ç‚¹ã€‚

```typescript
// å®šä¹‰æŒ‰é’®ä»¥æŠ“å–å’Œè¿”å›å¯¹è±¡
async function dropHandler() {
  try {
    await zMove(motionClient, armClient, 240);
    await grab(boardClient, gripperClient);
    await delay(1000);
    await zMove(motionClient, armClient, moveHeight);
    await home(motionClient, armClient);
    await delay(1000);
    await release(boardClient, gripperClient);
  } catch (error) {
    console.log(error);
    styleMove('error');
    setTimeout(() => {
      styleMove('ready');
      isMoving = false;
    }, 2000);
    return false;
  }
  return true;
}

setButtonBehavior(dropbutton, () => dropHandler());
```

åœ¨æœ€åçš„ä»£ç ç‰‡æ®µä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬ä¸‰æ¬¡è¿­ä»£çš„é€šç”¨ç§»åŠ¨å¤„ç†ç¨‹åºç¼–æ’ï¼ŒåŒ…å«äº†æ›´å¤šçš„å‘½ä»¤å’Œå¼‚æ­¥è¡Œä¸ºã€‚`dropHandler` è´Ÿè´£ä»æ¸¸æˆåº•éƒ¨æŠ“å–ä¸€ä¸ªçƒå¹¶å°†å…¶ç§»åŠ¨åˆ°æŠ•æ”¾æ§½é‡Šæ”¾ï¼ˆå¦‚æœå®ƒèƒ½å¤ŸæŠ“åˆ°ä¸€ä¸ªçƒçš„è¯ï¼‰ã€‚è¿™ä¸å…¶ä»–ç§»åŠ¨å¤„ç†ç¨‹åºæœ‰ç€æ˜æ˜¾çš„ä¸åŒï¼Œå³ä½¿åœ¨é”™è¯¯å¤„ç†é€»è¾‘ä¸Šæœ‰é‡å ã€‚

åœ¨å®Œæˆå¯¹æ¸¸æˆä»£ç çš„åˆæ­¥åˆ†æåï¼Œè®©æˆ‘ä»¬å°è¯•åœ¨ Stately Studio ä¸­å¯¹å…¶è¿›è¡Œå»ºæ¨¡ï¼

## åœ¨ Stately Studio ä¸­å»ºæ¨¡

å®Œæˆçš„çŠ¶æ€æœºï¼š

<EmbedMachine
  name="A state machine demonstrating the logic for a robotic claw game that can move around and pick up balls."
  embedURL="https://stately.ai/registry/editor/embed/40eef216-51c5-4c58-aa9a-22b5ed25ee68?mode=design&machineId=72280163-4dde-4e85-a2a1-b30f49c7f27f"
/>

åœ¨æˆ‘ä»¬æ·±å…¥ç ”ç©¶ Stately æ¨¡å‹æ—¶ï¼Œæˆ‘å°†ä½¿ç”¨ MermaidJS å›¾è¡¨æ¥èšç„¦æŸäº›éƒ¨åˆ†å¹¶æä¾›â€œå¢å¼ºâ€è§†å›¾ã€‚

![çŠ¶æ€å›¾ï¼Œå±•ç¤ºäº†æŠ“å¨ƒå¨ƒæ¸¸æˆçŠ¶æ€æœºçš„èµ·å§‹çŠ¶æ€](./mermaid-diagram-starting-states.svg)

æ­£å¦‚æˆ‘ä»¬åœ¨é¦–æ¬¡æ¢ç´¢ä¸»è¦ TypeScript é€»è¾‘æ—¶æåˆ°çš„ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªç›¸å½“ç»å…¸çš„ `initializing` èµ·å§‹çŠ¶æ€ï¼Œåœ¨ `connect` åŠ¨ä½œåè½¬æ¢åˆ° `connectingToMachine` çŠ¶æ€ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ä½•æ—¶å¼€å§‹è¿æ¥æˆ–åœ¨å‘ç”ŸæŸäº›æƒ…å†µæ—¶å°è¯•é‡æ–°è¿æ¥ï¼›æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨æœªæ¥å°†å…¶ç§°ä¸º `disconnected` ä»¥ä¾¿æ›´æ¸…æ™°ã€‚åœ¨ `connectingToMachine` çŠ¶æ€ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨ä¸€ä¸ª `createRobotClient` actorï¼Œå®ƒå¤åˆ¶ `connect` è¾…åŠ©å‡½æ•°å¹¶åœ¨æˆåŠŸæ—¶å°†å®¢æˆ·ç«¯åˆ†é…ç»™æœºå™¨ä¸Šä¸‹æ–‡ã€‚ä½œä¸ºå¯¹åŸå§‹é€»è¾‘çš„ç¬¬ä¸€ä¸ªæ”¹è¿›ï¼Œæˆ‘ä»¬ä¸ºè¯¥ actor æ·»åŠ äº†ä¸€ä¸ªæ˜¾å¼é”™è¯¯å¤„ç†ç¨‹åºï¼Œä»¥è½¬æ¢åˆ° `clientErrored` çŠ¶æ€ï¼Œå¹¶å…è®¸é‡è¯•æ“ä½œè½¬æ¢å› `initializing`ã€‚`connected` çŠ¶æ€å°†åœ¨è¿›å…¥æ—¶å°†å¿…è¦çš„ç»„ä»¶å®¢æˆ·ç«¯åˆ†é…ç»™æœºå™¨ä¸Šä¸‹æ–‡åç«‹å³è½¬æ¢åˆ° `ready` çŠ¶æ€ã€‚

![çŠ¶æ€å›¾ï¼Œå±•ç¤ºäº†æŠ“å¨ƒå¨ƒæ¸¸æˆçŠ¶æ€æœºçš„ç§»åŠ¨çŠ¶æ€](./mermaid-diagram-moving-states.svg)

ä» `ready` çŠ¶æ€å¼€å§‹ï¼Œç¬¬ä¸€ä¸ªè¦æŸ¥çœ‹çš„åŠ¨ä½œæ˜¯ `move`ã€‚è¿™å°†è½¬æ¢åˆ° `moving` çŠ¶æ€ï¼ˆä¸å†éœ€è¦æ›´æ–°å•ç‹¬çš„å¸ƒå°”å˜é‡ ğŸ‰ï¼‰ï¼Œå¹¶è°ƒç”¨å¸¦æœ‰ä¸€ç»„è¾“å…¥å‚æ•°çš„ `armMover` actorï¼Œä»¥æŒ‡å®š `x` å’Œ `y` å‚æ•°ä»¥åŠç§»åŠ¨ç±»å‹ï¼š`planar` æˆ– `quadrant`ï¼›è¿™å…è®¸åˆå¹¶å·¥ä½œæµæ¥å¤„ç†è¿™ä¸¤ç§ç±»ä¼¼çš„äº¤äº’ã€‚æˆåŠŸåï¼Œæœºå™¨å°†ç«‹å³è½¬æ¢å› `ready`ã€‚é”™è¯¯æƒ…å†µæ˜¯æˆ‘æœ€å–œæ¬¢çš„éƒ¨åˆ†ä¹‹ä¸€ï¼›é™¤äº†æ˜¾å¼çš„ `displayingMoveError` çŠ¶æ€å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨ä¸€ä¸ªåœ°æ–¹çœ‹åˆ°è®¾å®šæ—¶é—´åçš„è‡ªåŠ¨è½¬æ¢ã€‚

![çŠ¶æ€å›¾ï¼Œå±•ç¤ºäº†æŠ“å¨ƒå¨ƒæ¸¸æˆçŠ¶æ€æœºçš„æŠ“å–çŠ¶æ€](./mermaid-diagram-picking-states.svg)

æœ€åä¸€ä¸ªåŠ¨ä½œçœ‹èµ·æ¥å‡ ä¹ä¸å‰ä¸€ä¸ªåŠ¨ä½œç›¸åŒï¼šæˆ‘ä»¬æ‰§è¡Œ `dropAndHome` åŠ¨ä½œä»¥è½¬æ¢åˆ° `picking` çŠ¶æ€ï¼Œå¹¶è°ƒç”¨ `dropHandler` actorã€‚æˆ‘ä»¬æ²¡æœ‰å°† `picking` ä½œä¸º `armMover` è¾“å…¥ä¸­çš„ä¸€ä¸ªé€‰é¡¹ï¼Œè€Œæ˜¯å°†è¿™ä¸ªæ›´å¤æ‚çš„å·¥ä½œæµåˆ†å¼€ï¼Œä»¥ä¾¿ä»¥åæœ‰æœºä¼šè¿›è¡Œä¼˜åŒ–ã€‚

å³ä½¿åœ¨å°†ç”Ÿæˆçš„çŠ¶æ€æœºé…ç½®åŒ…å«åˆ°ä»£ç åº“ä¹‹å‰ï¼Œè¿™ç§å¯¹æœºå™¨æ§åˆ¶é€»è¾‘çš„é«˜çº§è§†å›¾ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆæ£’çš„å·¥å…·ï¼Œå¯ä»¥åŒ…å«åœ¨æ–‡æ¡£ä¸­ï¼Œå¹¶æ•™å¯¼å›¢é˜Ÿçš„å…¶ä»–æˆå‘˜å¦‚ä½•å·¥ä½œã€‚

## é‡æ„ä»£ç 

ä¸ºäº†å¯åŠ¨è¿™ä¸ªçŠ¶æ€æœºçš„å®ç°ï¼Œæˆ‘ä» Stately Studio è·å–äº† XState v5 ç”Ÿæˆçš„ TypeScript ä»£ç ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æŠ“å¨ƒå¨ƒæ¸¸æˆåº”ç”¨çš„ `main.ts` ä¸­ï¼Œä»¥å¼€å§‹å¡«å……åŠ¨ä½œå’Œ actorã€‚

```typescript
const clawMachine = setup({
  types: {
    context: {} as ClawMachineContext, // æŠ½è±¡ä¸ºæ˜¾å¼ç±»å‹ä»¥æé«˜å¯è¯»æ€§
    events: {} as ClawMachineEvent, // æŠ½è±¡ä¸ºæ˜¾å¼ç±»å‹ä»¥æé«˜å¯è¯»æ€§
  },
  actions: {
    assignClients: assign({
      motionClient: ({ context }, params: ClientNameParams) =>
        new MotionClient(context.machineClient, params.motionClientName),

      boardClient: ({ context }, params: ClientNameParams) =>
        new BoardClient(context.machineClient, params.boardClientName),

      armClient: ({ context }, params: ClientNameParams) =>
        new ArmClient(context.machineClient, params.armClientName),

      gripperClient: ({ context }, params: ClientNameParams) =>
        new GripperClient(context.machineClient, params.gripperClientName),
    }),
    assignError: assign({
      error: (_, params: { error: Error }) => params.error,
    }),
    assignRobotClient: assign({
      machineClient: (_, params: { client: Client }) => {
        return params.client;
      },
    }),
    clearError: assign({ error: null }),
    styleMove: (_, _params: { state: 'moving' | 'ready' | 'error' }) => {},
    logError: (_, params: { error: Error }) => {
      console.error(params.error);
    },
  },
  actors: {
    createRobotClient: fromPromise<
      Client,
      { apiKey: string; apiKeyId: string; locationAddress: string }
    >(async ({ input }) => {
      const credential = {
        type: 'api-key',
        payload: input.apiKey,
      };

           // è¿™æ˜¯ä½ çš„æœºå™¨äººä¸»è¦éƒ¨åˆ†çš„ä¸»æœºåœ°å€ã€‚
      const host = input.locationAddress;

      return createRobotClient({
        host,
        credential,
        authEntity: input.apiKeyId,
        signalingAddress: 'https://app.viam.com:443',
      });
    }),
    moveHandler: fromPromise<void, MoveInput>(async ({ input }) => {
      if (input.target == 'quadrant') {
        await moveToQuadrant(
          input.motionClient,
          input.armClient,
          input.x,
          input.y,
        );
      }
      if (input.target == 'planar') {
        await inPlaneMove(
          input.motionClient,
          input.armClient,
          input.x,
          input.y,
        );
      }
    }),
    dropHandler: fromPromise<void, ClawMachineContext & { moveHeight: number }>(
      async ({ input }) => {
        await zMove(input.motionClient, input.armClient, 240);
        await grab(input.boardClient, input.gripperClient);
        await delay(1000);
        await zMove(input.motionClient, input.armClient, input.moveHeight);
        await home(input.motionClient, input.armClient);
        await delay(1000);
        await release(input.boardClient, input.gripperClient);
      },
    ),
  },
}).createMachine({
  context: { error: null } as ClawMachineContext,
  id: 'Claw Machine',
  initial: 'initializing',
  states: {
    initializing: {
      on: {
        connect: {
          target: 'connectingToMachine',
        },
      },
    },
    connectingToMachine: {
      invoke: {
        id: 'clientConnection',
        input: {
          apiKey: robotAPIKey,
          apiKeyId: robotAPIKeyID,
          locationAddress: robotLocation,
        },
        onDone: {
          target: 'connected',
          actions: {
            type: 'assignRobotClient',
            params: ({ event }) => ({ client: event.output }),
          },
        },
        onError: {
          target: 'clientErrored',
          actions: [
            {
              type: 'assignError',
              params: ({ event }) => ({ error: event.error as Error }),
            },
            {
              type: 'logError',
              params: ({ event }) => ({ error: event.error as Error }),
            },
          ],
        },
        src: 'createRobotClient',
      },
    },
    connected: {
      always: {
        target: 'ready',
      },
      entry: {
        type: 'assignClients',
        params: {
          motionClientName,
          boardClientName,
          armClientName,
          gripperClientName,
        },
      },
    },
    clientErrored: {
      entry: { type: 'styleMove', params: { state: 'error' } },
      on: {
        retry: {
          target: 'initializing',
          actions: { type: 'clearError' },
        },
      },
    },
    ready: {
      entry: { type: 'styleMove', params: { state: 'ready' } },
      on: {
        move: {
          target: 'moving',
        },
        dropAndHome: {
          target: 'picking',
        },
      },
    },
    moving: {
      entry: { type: 'styleMove', params: { state: 'moving' } },
      invoke: {
        id: 'armMover',
        input: ({ context, event }) => {
          assertEvent(event, 'move');

          if (event.target == 'home') {
            return { ...context, target: event.target };
          }

          return {
            ...context,
            target: event.target,
            x: event.x,
            y: event.y,
          };
        },
        onDone: {
          target: 'ready',
        },
        onError: {
          target: 'displayingMoveError',
          actions: [
            {
              type: 'assignError',
              params: ({ event }) => ({ error: event.error as Error }),
            },
            {
              type: 'logError',
              params: ({ event }) => ({ error: event.error as Error }),
            },
          ],
        },
        src: 'moveHandler',
      },
    },
    picking: {
      entry: { type: 'styleMove', params: { state: 'moving' } },
      invoke: {
        id: 'picker',
        input: ({ context }) => ({ ...context, moveHeight }),
        onDone: {
          target: 'ready',
        },
        onError: {
          target: 'displayingPickerError',
          actions: [
            {
              type: 'assignError',
              params: ({ event }) => ({ error: event.error as Error }),
            },
            {
              type: 'logError',
              params: ({ event }) => ({ error: event.error as Error }),
            },
          ],
        },
        src: 'dropHandler',
      },
    },
    displayingMoveError: {
      entry: { type: 'styleMove', params: { state: 'error' } },
      after: {
        '3000': {
          target: 'ready',
          actions: { type: 'clearError' },
        },
      },
    },
    displayingPickerError: {
      entry: { type: 'styleMove', params: { state: 'error' } },
      after: {
        '2000': {
          target: 'ready',
          actions: { type: 'clearError' },
        },
      },
    },
  },
});
```

å¦‚æœæˆ‘ä»¬å°† `moveHandler` å’Œ `dropHandler` actor ä¸åŸå§‹ä»£ç è¿›è¡Œæ¯”è¾ƒï¼Œå®ƒä»¬æœ¬è´¨ä¸Šä¸ä¹‹å‰ç›¸åŒï¼Œä½†æˆåŠŸå’Œé”™è¯¯å¤„ç†è¢«æå‡åˆ°äº†çŠ¶æ€æœºçº§åˆ«ã€‚

ä½ å¯èƒ½è¿˜ä¼šæ³¨æ„åˆ° `styleMove` è¾…åŠ©å‡½æ•°è¢«ç”¨ä½œå¿…è¦çŠ¶æ€çš„æ˜¾å¼è¿›å…¥åŠ¨ä½œï¼Œä½¿å…¶æ¯”ä»¥å‰æ›´ä¸€è‡´ã€‚

é…ç½®å¥½è¿™ä¸ª `clawMachine` åï¼Œ`main` å‡½æ•°çš„ä¸»ä½“éƒ¨åˆ†è¢«å¤§å¤§ç®€åŒ–äº†ï¼š

```typescript
function main() {
  const clawMachineActor = createActor(
    clawMachine.provide({
      actions: { styleMove },
    }),
  );

  document.body.addEventListener('pointerdown', (event) => {
    if (
      event.target instanceof HTMLElement &&
      'event' in event.target.dataset
    ) {
      const {
        event: machineEvent,
        target,
        x = '0',
        y = '0',
      } = event.target.dataset;

      if (machineEvent === 'move') {
        if (target === 'planar' || target === 'quadrant') {
          clawMachineActor.send({
            type: machineEvent,
            target,
            x: parseInt(x, 10),
            y: parseInt(y, 10),
          });
        }
      }
      if (machineEvent === 'dropAndHome')
        clawMachineActor.send({ type: machineEvent });
    }
  });

  clawMachineActor.start();
  clawMachineActor.send({ type: 'connect' });
}
```

`styleMove` åŠ¨ä½œåœ¨è¿™é‡Œé…ç½®ï¼Œè€Œä¸æ˜¯é»˜è®¤åŒ…å«åœ¨ `clawMachine` é…ç½®ä¸­ï¼Œè¿™æ˜¯ä¸ªäººåå¥½ï¼Œä»¥ä¿æŒ DOM é€»è¾‘çš„ç‹¬ç«‹æ€§ã€‚åœ¨æˆ‘å¤„ç†è¿™ä¸ªé—®é¢˜æ—¶ï¼Œæˆ‘å†³å®šç®€åŒ– `styleMove`ï¼Œå› ä¸ºå®ƒåªéœ€è¦åœ¨ HTML ä¸­åæ˜ å½“å‰çŠ¶æ€ä»¥æœ‰æ¡ä»¶åœ°è®¾ç½®ç½‘æ ¼æ ·å¼ï¼ˆå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªä¸å¸¦å®‰å…¨æ£€æŸ¥çš„å•è¡Œä»£ç ï¼‰ï¼š
```typescript
function styleMove(_, params: { state: 'moving' | 'ready' | 'error' }) {
  const container = document.getElementById('grid-container');
  if (container == null) return;

  container.dataset.state = params.state;
}
```

The updated CSS:

```css
.grid-container[data-state='ready'] {
  background-color: #6ded8a;
}

.grid-container[data-state='moving'] {
  background-color: #ffee99;
}

.grid-container[data-state='error'] {
  background-color: #aa0000;
}
```

æŠ“å¨ƒå¨ƒæ¸¸æˆæŒ‰é’®çš„äº‹ä»¶å¤„ç†ç¨‹åºä¹Ÿè¿›è¡Œäº†é‡æ„ï¼Œé€šè¿‡åœ¨é™æ€ HTML ä¸Šå°†åŠ¨ä½œè¾“å…¥æŒ‡å®šä¸ºæ•°æ®å±æ€§ï¼Œå‡å°‘äº†å†—ä½™çš„ TypeScript ä»£ç é‡ï¼š

```html
<button
  id="forward-button"
  class="grid-arrow grid-arrow-up"
  data-event="move"
  data-target="planar"
  data-x="-20"
  data-y="0"
>
  Forward
</button>
```

ç°åœ¨å®ƒåªæ˜¯ä¸€ä¸ªå•ä¸€çš„å§”æ‰˜äº‹ä»¶å¤„ç†ç¨‹åºï¼Œç”¨äºå‘ `clawMachine` å‘é€äº‹ä»¶ï¼Œå¹¶ä¿è¯æ‰€æœ‰çš„ä¿æŠ¤å’Œé”™è¯¯å¤„ç†ï¼

ä¸€æ—¦å»ºæ¨¡å®Œæˆï¼Œç”±äºæˆ‘å¯¹è¯¥åº“çš„ç†Ÿæ‚‰ä»¥åŠå¯¹ Viam API äº¤äº’å¦‚ä½•æ’å…¥çŠ¶æ€æœºé…ç½®çš„æ›´æ¸…æ™°ç†è§£ï¼Œé‡æ„ä»£ç ä»¥ä½¿ç”¨ `xstate` çš„è¿‡ç¨‹ä¸åˆ°ä¸€ä¸ªå°æ—¶ã€‚

ä½ å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹å®Œæ•´çš„é‡æ„ PRï¼šhttps://github.com/viam-labs/claw-game/pull/17

## åæ€

è§‚çœ‹å®é™…æ•ˆæœï¼š

<iframe
  width="300"
  height="500"
  src="https://www.youtube.com/embed/_bJADuMUDq8"
  title="Robot Arcade Claw Game in Action!"
  frameborder="0"
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
  referrerpolicy="strict-origin-when-cross-origin"
  allowfullscreen
></iframe>

æ€»ä½“è€Œè¨€ï¼Œæˆ‘å‘ç°ä»å¯è§†åŒ–é€»è¾‘åˆ°å°†ç”Ÿæˆçš„ä»£ç æ’å…¥æˆ‘çš„ Web åº”ç”¨ç¨‹åºçš„æ•´ä¸ªè¿‡ç¨‹éå¸¸æœ‰æˆæ•ˆã€‚æˆ‘å·²ç»ç¡®å®šäº†æ‰©å±•å’Œæ”¹è¿›æœºå™¨çš„æ–¹æ³•ï¼Œä¾‹å¦‚åœ¨é»˜è®¤çš„ `logError` åŠ¨ä½œä¸­æ·»åŠ é”™è¯¯æ•è·ï¼Œå¹¶å°† `dropHandler` Promise actor åˆ†è§£ä¸ºæ˜¾å¼çš„çŠ¶æ€æœº actorã€‚æˆ‘å¸Œæœ›æˆ‘çš„å›¢é˜Ÿå’Œ [Viam ç¤¾åŒº](https://discord.gg/viam) çš„äººä»¬èƒ½å¤Ÿé€šè¿‡è¿™ä¸ªé‡æ„æ›´å¥½åœ°ç†è§£è¿™ä¸ªåº”ç”¨ç¨‹åºã€‚

ç¥ä½ æ„å»ºæ„‰å¿«ï¼
